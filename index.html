<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Pro Chat: Persistent Edition</title>
    <style>
        @import url('https://fonts.cdnfonts.com/css/minecraftia');
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        * { box-sizing: border-box; }
        body { margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.5s; }
        
        #sidebar { width: 30%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; z-index: 10; transition: inherit; }
        
        /* Contorno Neon nos √çcones Principais */
        #toggle-btn { font-size: 130px; cursor: pointer; transition: 0.3s; user-select: none; z-index: 11; image-rendering: pixelated; }
        .theme-amigavel #toggle-btn { filter: drop-shadow(0 0 15px #ff4d7d); }
        .theme-nao-amigavel #toggle-btn { filter: drop-shadow(0 0 20px #ff0000); }

        #chat-container { width: 70%; display: flex; flex-direction: column; position: relative; transition: inherit; }
        #header { padding: 30px; text-align: center; font-size: 24px; font-weight: bold; transition: inherit; z-index: 5; border-bottom: 4px solid rgba(0,0,0,0.05); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 5; }
        
        .message { max-width: 80%; padding: 15px; border-radius: 12px; position: relative; font-size: 14px; animation: fadeIn 0.3s ease; word-wrap: break-word; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .message img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        .my-message { align-self: flex-end; }

        /* Part√≠culas Flutuantes e Clic√°veis */
        .bg-particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }
        .particle { 
            position: absolute; 
            bottom: -80px; 
            cursor: pointer; 
            z-index: 20; /* Garante que estejam acima de outros elementos do background */
            pointer-events: auto; /* Permite cliques */
            image-rendering: pixelated; 
            transition: transform 0.1s; /* Para o efeito de clique */
            user-select: none;
            opacity: 0.7; /* Suave */
        }
        .particle:active { transform: scale(1.5); } /* Efeito de clique */

        @keyframes moveUp { 
            0% { transform: translateY(0) rotate(0deg); opacity: 0.7; } 
            100% { transform: translateY(-115vh) rotate(360deg); opacity: 0; } 
        }

        /* TEMA AMIG√ÅVEL */
        .theme-amigavel { background-color: #fff; font-family: 'Minecraftia', sans-serif; }
        .theme-amigavel #sidebar { background: #fff; border-right: 4px solid #ffeef2; }
        .theme-amigavel #header { color: #ff4d7d; }
        .theme-amigavel .message { background: #fff; border: 3px solid #ffcada; color: #555; box-shadow: 4px 4px 0px #eee; }
        .theme-amigavel .my-message { background: #ff85a2; color: white; border-color: #ff4d7d; }

        /* TEMA INFERNAL */
        .theme-nao-amigavel { background-color: #000; font-family: 'Share Tech Mono', monospace; }
        .theme-nao-amigavel #sidebar { border-right: 2px solid #ff0000; }
        .theme-nao-amigavel #header { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
        .theme-nao-amigavel .message { background: #000; border: 1px solid #ff0000; color: #ff4444; box-shadow: 0 0 10px rgba(255,0,0,0.3); }
        .theme-nao-amigavel .my-message { color: white; border-color: #ff0000; box-shadow: 0 0 15px #ff0000; }

        /* Input Area */
        #input-area { padding: 20px; display: flex; gap: 10px; z-index: 10; }
        input[type="text"] { flex: 1; padding: 12px; outline: none; border-radius: 8px; border: 2px solid #ddd; font-family: inherit; }
        .theme-nao-amigavel input[type="text"] { background: #000; border-color: #ff0000; color: #ff0000; }
        
        label, button { cursor: pointer; padding: 10px 15px; border-radius: 8px; border: none; font-family: inherit; font-weight: bold; }
        .theme-amigavel button, .theme-amigavel label { background: #ff4d7d; color: white; }
        .theme-nao-amigavel button, .theme-nao-amigavel label { background: #000; border: 1px solid #ff0000; color: #ff0000; }
        input[type="file"] { display: none; }
    </style>
</head>
<body class="theme-amigavel">
    <div id="sidebar">
        <div class="bg-particles" id="sidebar-particles"></div>
        <div id="toggle-btn">‚ù§Ô∏è</div>
    </div>
    <div id="chat-container">
        <div class="bg-particles" id="chat-particles"></div>
        <div id="header">AMIG√ÅVEL</div>
        <div id="messages"></div>
        <div id="input-area">
            <label for="img-input">üì∑</label><input type="file" id="img-input" accept="image/*">
            <label for="audio-input">üéôÔ∏è</label><input type="file" id="audio-input" accept="audio/*">
            <input type="text" id="msg-input" placeholder="Digite...">
            <button id="send-btn">ENVIAR</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = 'amigavel';
        const user = "User_" + Math.floor(Math.random() * 99);
        const LIFE_TIME = 5 * 60 * 1000; // 5 minutos
        let particleInterval; // Vari√°vel para controlar o intervalo das part√≠culas

        // SALVAR MENSAGEM NO LOCALSTORAGE
        function saveMessage(msg) {
            let history = JSON.parse(localStorage.getItem('chat_history') || '[]');
            msg.timestamp = Date.now();
            history.push(msg);
            localStorage.setItem('chat_history', JSON.stringify(history));
        }

        // CARREGAR E FILTRAR MENSAGENS
        function renderChat() {
            const container = document.getElementById('messages');
            container.innerHTML = ''; // Limpa tela
            
            let history = JSON.parse(localStorage.getItem('chat_history') || '[]');
            const now = Date.now();

            // Filtragem: mesma sala E menos de 5 minutos
            const validMessages = history.filter(msg => {
                const isFromRoom = msg.room === currentRoom;
                const isNotExpired = (now - msg.timestamp) < LIFE_TIME;
                return isFromRoom && isNotExpired;
            });

            // Atualiza o storage removendo as expiradas de todas as salas
            const globalValid = history.filter(msg => (now - msg.timestamp) < LIFE_TIME);
            localStorage.setItem('chat_history', JSON.stringify(globalValid));

            validMessages.forEach(displayMessage);
        }

        function displayMessage(msg) {
            const div = document.createElement('div');
            div.className = 'message ' + (msg.user === user ? 'my-message' : '');
            let content = `<b>${msg.user}</b><br>`;
            if (msg.text) content += `<span>${msg.text}</span>`;
            if (msg.file) {
                if (msg.fileType === 'image') content += `<img src="${msg.file}">`;
                if (msg.fileType === 'audio') content += `<audio controls src="${msg.file}"></audio>`;
            }
            div.innerHTML = content;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            if (input.value.trim()) {
                const msg = { room: currentRoom, user: user, text: input.value };
                socket.emit('chat message', msg);
                input.value = '';
            }
        }

        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
        document.getElementById('send-btn').onclick = sendMessage;

        socket.on('chat message', (msg) => {
            saveMessage(msg);
            if (msg.room === currentRoom) displayMessage(msg);
        });

        // --- Part√≠culas Flutuantes e Clic√°veis ---
        function createParticle(containerId, emoji) {
            const container = document.getElementById(containerId);
            const p = document.createElement('div');
            p.className = 'particle';
            p.innerText = emoji;
            p.style.left = Math.random() * 90 + '%';
            p.style.fontSize = (Math.random() * 20 + 30) + 'px';
            p.style.animation = `moveUp ${(Math.random() * 2 + 3)}s linear forwards`;
            
            p.onclick = function() {
                this.innerText = currentRoom === 'amigavel' ? 'üí•' : 'üî•'; // Efeito de explos√£o
                this.style.transform = 'scale(1.5)';
                this.style.opacity = '1';
                setTimeout(() => this.remove(), 150);
            };

            container.appendChild(p);
            setTimeout(() => { if(p) p.remove(); }, 4000); // Remove depois da anima√ß√£o
        }

        function startParticleEffects(emoji) {
            if (particleInterval) clearInterval(particleInterval); // Limpa o intervalo anterior
            particleInterval = setInterval(() => {
                createParticle('sidebar-particles', emoji);
                createParticle('chat-particles', emoji);
            }, 600);
        }
        // --- Fim das Part√≠culas ---


        // TROCA DE CANAL
        document.getElementById('toggle-btn').onclick = function() {
            if (currentRoom === 'amigavel') {
                currentRoom = 'nao-amigavel';
                document.body.className = 'theme-nao-amigavel';
                this.innerText = 'üíÄ';
                document.getElementById('header').innerText = 'MODO INFERNAL';
                startParticleEffects('üíÄ'); // Inicia caveiras
            } else {
                currentRoom = 'amigavel';
                document.body.className = 'theme-amigavel';
                this.innerText = '‚ù§Ô∏è';
                document.getElementById('header').innerText = 'AMIG√ÅVEL';
                startParticleEffects('‚ù§Ô∏è'); // Inicia cora√ß√µes
            }
            socket.emit('join room', currentRoom);
            renderChat(); // Recarrega as mensagens da sala nova
        };

        // ARQUIVOS
        function sendFile(input, type) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    socket.emit('chat message', { room: currentRoom, user: user, text: '', file: e.target.result, fileType: type });
                };
                reader.readAsDataURL(file);
                input.value = '';
            }
        }
        document.getElementById('img-input').onchange = function() { sendFile(this, 'image'); };
        document.getElementById('audio-input').onchange = function() { sendFile(this, 'audio'); };

        // Timer de auto-limpeza a cada 15 segundos
        setInterval(renderChat, 15000);

        // Inicializar
        renderChat();
        startParticleEffects('‚ù§Ô∏è'); // Come√ßa com cora√ß√µes no modo amig√°vel
        socket.emit('join room', 'amigavel');
    </script>
</body>
</html>
